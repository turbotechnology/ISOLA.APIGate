# API: УРМОКС
API УРМОКС это набор функций Т9 . Вызов этих функций производится через метод ProcCall объекта [TBSession](https://paper.dropbox.com/doc/-9-PHP-5bhqG0R3hQUQG32UBarsR). В описании предполагается, что объект уже создан и соединение с Т9 установлено, т.е. успешно выполнен код:

    $t9 = new TBSession;
    $t9->ProcConnect($ProcServer, $ProcServer, $InfobaseName, $user, $pass, $role);

Напоминаю, все строки передаются/возвращаются в Т9 в кодировке win-1251

# Класс rwscso

Ошибки, если это не указано отдельно, возвращаются в формате:

    <Error>Сообщение об ошибке</Error>
----------
## Функция ClientList ✔️

По переданному параметру производит поиск клиентов по полям Имя, Серия и номер паспорта, ИНН. 
Возвращает список найденных клиентов в виде xml.

Пример**:**
`$t9->ProcCall('rwscso', 'ClientList', 'физли')` 
 

    <ClientList>
        <Client DocID="7808" Имя="ФизЛицо 022632233" СерияДок="" НомерДок="" ДатаРождения="01.01.1970" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
        <Client DocID="9797" Имя="ФизЛицо 042940352" СерияДок="" НомерДок="" ДатаРождения="01.01.1970" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
        <Client DocID="9798" Имя="ФизЛицо 039556655" СерияДок="" НомерДок="" ДатаРождения="01.01.1970" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
        <Client DocID="9799" Имя="ФизЛицо 091101514" СерияДок="" НомерДок="" ДатаРождения="01.01.1970" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
        <Client DocID="9806" Имя="ФизЛицо 016685286" СерияДок="" НомерДок="" ДатаРождения="" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
        <Client DocID="9810" Имя="ФизЛицо 050083475" СерияДок="" НомерДок="" ДатаРождения="" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
        <Client DocID="9811" Имя="ФизЛицо 007554595" СерияДок="" НомерДок="" ДатаРождения="" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
        <Client DocID="9820" Имя="ФизЛицо 008024442" СерияДок="" НомерДок="" ДатаРождения="" МестоРождения="" ИНН="" МобТелефон="" e_mail=""/>
    </ClientList>


----------
## Функция ClientInfo ✔️

По DocID клиента возвращает информацию о клиенте в виде xml. 
В случае если передан некорректный DocID возвращает пустую строку.
Пример**:**
`$t9->ProcCall('rwscso', 'ClientInfo', '7808')` 
*Если у клиента нет подключенных договоров:* 

    <ClientList>
        <Client DocID="7808" Имя="Иванов И.И." СерияДок="1234" НомерДок="123456" ДатаРождения="01.01.1970" МестоРождения="Севастополь" ИНН="123456789012" МобТелефон="71231234567" e_mail="ivanov.ii@mail.ru"/>
    </ClientList>

*Если у клиента есть подключенные договора:*

    <ClientList>
        <Client DocID="7808" Имя="Иванов И.И." СерияДок="1234" НомерДок="123456" ДатаРождения="01.01.1970" МестоРождения="Севастополь" ИНН="123456789012" МобТелефон="71231234567" e_mail="ivanov.ii@mail.ru">
            <Agreement DocID="1702526" Номер="Договор N087776052" Статус="Черновик" Продукт="1650242"/>
            <Agreement DocID="1702531" Номер="Договор N027740790" Статус="" Продукт="1650242" Оценка="123.45"/>
        </Client>
    </ClientList>

*В необязательном параметре Client\Agreement\Продукт возвращается DocID продукта, к которому относится договор.*
*Параметр Client\Agreement\Статус определяет является ли договор готовым (статус заполнен) или незавершенным (статус отсутствует).*
Необязательный п*араметр Client\Agreement\Оценка возвращает рыночную стоимость торгового портфеля в рублях.*

----------
**## Функция ProductList ✔️

Возвращает список продуктов в виде xml.
Иконка продукта передаётся в атрибуте ПриложенныйФайл, закодирована в Base64. Имя файла в атрибуте ИмяПриложенногоФайла.
Пример**:**
`$t9->ProcCall('rwscso', 'ProductList')` 


    <ProductList>
        <GroupDoc DocID="1577046" Имя="Базовые продукты">
            <Product DocID="1650242" GroupDoc.DocID="1577046" Имя="Брокерское обслуживание" ico=""/>
            <Product DocID="1650242" GroupDoc.DocID="1577046" Имя="Доверительное управление" ico=""/>
        </GroupDoc>
        <GroupDoc DocID="1651307" Имя="Комплексные коробочные продукты">
            <Product DocID="1651308" GroupDoc.DocID="1651307" Имя="Инвестиционное консультирование на брокерском счете" ico=""/>
            <Product DocID="1651309" GroupDoc.DocID="1651307" Имя="Индивидуальный инвестиционный счет" Лимит="1" ПриложенныйФайл="LnBuZw==" ИмяПриложенногоФайла="ico.png"/>
        </GroupDoc>
        <GroupDoc DocID="1577047" Имя="Ещё одна группа">
            <Product DocID="1650243" GroupDoc.DocID="1577047" Имя="Бесполезная услуга"/>
        </GroupDoc>
    </ProductList>



----------
## Функция ProductInfo ✔️

Возвращает информацию о продукте (шаблоне) в виде xml. В качестве параметра передаются DocID клиента и DocID продукта разделённые символом “|”.
Возвращает xml с информацией о продукте в случае успеха, ошибку в противном случае. 
Пример**:**
`$t9->ProcCall('rwscso', 'ProductInfo', '7808|1650242')` 


    <ProductList>
    <GroupDoc DocID="1880809" Имя="Комплексные коробочные продукты">
        <Product StepCount="2" DocID="1880814" GroupDoc.DocID="1880809" Имя="Индивидуальный инвестиционный счет"/>       
    </GroupDoc>
    </ProductList>
    

 

----------
## Функция CreateAgreement ✔️

Создаёт новый (пустой) договор по указанному продукту. В качестве параметра передаются DocID клиента и DocID продукта, DocID менеджера, телефон и email разделённые символом “|”.
Возвращает xml содержащий DocID созданного договора и параметры необходимые для заполнения шаблонов в случае успеха, ошибку в противном случае. 

Атрибут PatternSkip (значения 1/0) тэга Pattern показывает, нужно ли загружать скан сформированный по этому шаблону в Т9. Если атрибут установлен (1), то файл загружать НЕ НУЖНО. Если атрибут не установлен (0 или отсутствует), то файл загружать нужно.

Пример**:**
`$t9->ProcCall('rwscso', 'CreateAgreement', '7808|1650242|9822|телефон|mail')` 
В случае успеха:

    <Agreement DocID="1880838" StepCount="2">
        <Pattern Step="1" Pattern="ЗаявлОПрисоедКРеглам_ФЛ_ИИС" PatternName="Заявление о присоединении к Регламенту" ПолнИмя="Иванов Иван Иванович" Имя="Иванов И.И." ИНН="123456789011" АдресРегистрации="119334, Москва, ул. Бардина, д. 6, стр. 2" СтрВидДок="Паспорт гражданина РФ" СерияДок="1111" НомерДок="111111" КемВыданДок="ОВД Иваново" ДатаВыдачиДок="01.01.2001" КодПодразделения="111-111"/>
        <Pattern Step="1" Pattern="ЗаявлениеНаобслуживание" PatternName="Заявление на обслуживание"/>
        <Pattern Step="1" Pattern="УведомлениеОЛичномПароле" PatternName="Уведомление о личном пароле" PatternSkip="1"/>
        <Pattern Step="1" Pattern="ЗаявлНаПодклКИТСQUIK" PatternName="Заявление на подключение QUIK"/>
        <Pattern Step="2" Pattern="ДепоДоговор_АТБ" PatternName="Депозитарный договор"/>
        <Pattern Step="2" Pattern="ДопСоглКДепоДоговору" PatternName="Доп.согл. к депо договору"/>
        <Pattern Step="2" Pattern="ДопСоглКДоговоруБанкСчета" PatternName="Доп.согл. к договору банк.счета"/>
        <Pattern Step="2" Pattern="АнкетаДепонента_ФЛ" PatternName="Анкета депонента"/>
        <Pattern Step="2" Pattern="СогласиеНаОбработкуДанных" PatternName="Согласие на ОПД"/>
        <Pattern Step="2" Pattern="ПоручениеНаОткрытиеСчета" PatternName="Поручение на открытие счета"/>
        <Pattern Step="2" Pattern="ПоручОНазначОператораСчета" PatternName="Поруч о назнач. оператора"/>
    </Agreement>

В случае ошибки:

    <Error>Шаблон "Безымянный" не найден.</Error>
----------
## Функция AgreementInfo ✔️

Возвращает информацию по договору. В качестве параметра передаются DocID договора и, при необходимости, код шаблона (отделяется символом “|”).
Пример**:**

    $t9->ProcCall('rwscso', 'AgreementInfo', '1230083')

Возвращаемый xml идентичен xml для [CreateAgreement](https://paper.dropbox.com/doc/API--x0Uu1rvjrx5osIp4Y4gMR#:uid=480330147355640&h2=%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F-CreateAgreement-%E2%9C%94%EF%B8%8F). 
Если передан код шаблона, то возвращается информация только по нему.

----------
## Функция AttachDocument ✔️

Прикрепляет документ к договору. Вызов имеет смысл для тех договоров, для которых был вызов CreateAgreement, но не было вызова ApplyAgreement/CancelAgreement, а так же для договоров в режиме редактирования. В качестве параметра передаются DocID договора, код шаблона, имя загруженного файла и прикрепляемый файл разделённые символом “|”.
Для версии 9.5 файл должен быть “обёрнут” в base64.
Возвращает идентификатор документа в случае успеха, ошибку в противном случае.
Пример**:**

    $data = file_get_contents('c:\example.pdf');
    $t9->ProcCall('rwscso', 'AttachDocument', '1230083|ЗаявлНаПодклКИТСQUIK|example.pdf' . $data)


    1230084
----------
## Функция ApplyAgreement ✔️

Проверяет корректность заполнения полей договора и меняет его состояние. Вызов имеет смысл для тех договоров, для которых был вызов CreateAgreement, но не было вызова ApplyAgreement/CancelAgreement, а так же для договоров в режиме редактирования.
Возвращает пусто в случае успеха, ошибку в противном случае.
Пример**:**
`$t9->ProcCall('rwscso', 'ApplyAgreement', '1230083')` 


    
----------
## Функция CancelAgreement ✔️

Для договоров, для которых отменяет изменения внесённые в договор удаляет договор.
Для договоров в режиме редактирования отменяет изменения внесённые в договор.
Метод предназначен для ситуация, когда при создании/редактировании что-то пошло не так.
Возвращает пусто в случае успеха, ошибку в противном случае.
Пример**:**
`$t9->ProcCall('rwscso', 'CancelAgreement', '1230083')` 


    <Error>Договор не может быть отменен.</Error>
----------
## Функция EditAgreement ✔️🆕 

Переводит договор в режим редактирования. Вызов имеет смысл только для тех договоров, для которых был вызов ApplyAgreement. После этого к договору можно применять функции AttachDocument/ApplyAgreement/CancelAgreement.
В качестве параметра передаются DocID договора, и перечень “ключ=значение”, разделённые символом “|”. На текущий момент поддерживаются следующие ключи: phone, email, account (счет выплаты). Прочие ключи игнорируются.
Возвращает пусто в случае успеха, ошибку в противном случае.
Пример**:**
`$t9->ProcCall('rwscso', 'EditAgreement', '1230083|phone=123|unsupported=0')` 


    <Error>Договор "1230083" не найден.</Error>
----------
## Функция OperatorName ✔️

Возвращает ФИО оператора.
Пример**:**
`$t9->ProcCall('rwscso', 'OperatorName')` 
  

    Оператор Т.С.
----------
## Функция ManagerList ✔️

Возвращает список менеджеров в виде xml.
Пример**:**
`$t9->ProcCall('rwscso', 'ManagerList')` 


    <UserList>
        <User DocID="9822" Имя="Кошкин С.С."/>
        <User DocID="9825" Имя="Мышкин С.С."/>
    </UserList>
----------
## Функция EmployeList ✔️

Возвращает список сотрудников в виде xml.
Пример**:**
`$t9->ProcCall('rwscso', 'EmployeList')` 


    <UserList>
        <User DocID="9822" Имя="Кошкин С.С."/>
        <User DocID="9825" Имя="Мышкин С.С."/>
    </UserList>


----------
## Функция TemplateList ✔️

Возвращает список доступных шаблонов и их контрольных сумм в виде xml. В качестве параметра принимает код шаблона, по которому нужно вернуть контрольную сумму.
Пример 1**:**
`$t9->ProcCall('rwscso', 'TemplateList')` 


    <TemplateList>
        <Template Код="ЗаявлОПрисоедКРеглам_ФЛ" CRC="2375F82C2519C844"/>
        <Template Код="ЗаявлОПрисоедКРеглам_ЮЛ" CRC="07755D710420078A"/>
        <Template Код="ЗаявлОПрисоедКРеглам_ИП" CRC="AB7F5D50559F55A0"/>
        <Template Код="ЗаявлениеНаобслуживание" CRC="3D8064B042C9E1B9"/>
        <Template Код="УведомлениеОЛичномПароле" CRC="696934D6F15E2BBD"/>
        <Template Код="ЗаявлНаПодклКИТСQUIK" CRC="43F3022DABD2259A"/>
        <Template Код="ЗаявлОПрисоедКРеглам_ФЛ_ИИС" CRC="D06FA6D830E4DE5A"/>
    </TemplateList>

Пример 2**:**
`$t9->ProcCall('rwscso', 'TemplateList', 'ЗаявлНаПодклКИТСQUIK')` 


    <TemplateList>
        <Template Код="ЗаявлНаПодклКИТСQUIK" CRC="43F3022DABD2259A"/>
    </TemplateList>


----------
## Функция TemplateInfo ✔️

Возвращает шаблон документа в виде потока. В качестве параметра принимает код шаблона.
Для версии 9.5 поток “обёрнут” в base64
Пример**:**
`t9->ProcCall('rwscso', 'TemplateInfo', 'ЗаявлОПрисоедКРеглам_ФЛ')` 


----------
## Функция MotivationCalculation ✔️

Возвращает <body> построенного отчёта “Расчёт мотивации” в формате html. В качестве параметра передаются даты начала и конца отчёта в формате `dd.mm.yyyy`, разделённые символом “|”. Конечная дата в отчёт не входит. 
Пример**:**
`t9->ProcCall('rwscso', 'MotivationCalculation', '01.01.2019|01.01.2020')`


